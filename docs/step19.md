### STEP 19: 성능 테스트 계획 및 실행

#### 1. **부하 테스트 시나리오**
- **전제**: 개발자 대상 콘서트를 개최한다고 가정합니다.
- 개발자 콘서트는 일반 대중공연보다 참가자가 적을 것으로 예상되지만, 개발자들이 몰려들어 예약 시작 시 트래픽이 집중될 것입니다.
- 예약 과정은 다음과 같습니다: 콘서트 조회 -> 대기열 신청 -> 좌석 예약 -> 결제.
- 부하 테스트는 부하 테스트, 내구성 테스트, 스트레스 테스트, 최고 부하 테스트로 나누어 진행됩니다.
- 1주일이라는 시간 제약을 고려해서 트래픽이 많이 몰릴 것으로 예상되는 '콘서트 조회'와 '대기열 신청'에 집중하여 테스트를 진행합니다.
- EC2 프리티어 성능 수준에 맞추어 Docker 리소스를 제한합니다.

#### 2. **테스트 시나리오**
- **Load Test**: 예상되는 일반적인 부하에서 1분간 지속적인 호출을 실행합니다.
- **Stress Test**: 점진적으로 가상 사용자(VU)를 증가시켜 시스템에 과부하를 유도하고, 최대 처리 한계를 평가합니다.
- **Peak Test**: 단기간에 급격히 부하를 발생시켜 시스템이 이를 어떻게 처리하는지 확인합니다.

- **시나리오 1: 동시 조회 요청 처리**
  - **조회 API**를 호출하여 실시간 좌석 정보를 확인합니다.

- **시나리오 2: 동시 대기열 요청 처리**
  - **대기열 API**를 호출하여 대기열에 등록합니다.

#### 3. **테스트 도구 및 환경**
- **도구**:
  - k6를 사용하여 부하 테스트 스크립트를 작성합니다.
  - Docker Compose를 활용하여 테스트 환경을 구성합니다.
  - influxdb와 grafana를 사용하여 테스트 결과를 시각화합니다.
  - Docker Desktop의 'live chart' 익스텐션을 활용하여 각 컨테이너의 부하를 모니터링하고 병목현상을 감지합니다.
  
- **테스트 환경**:
  - NestJS
  - PostgreSQL
  - Redis
  - Docker 컨테이너로 분리된 실행 환경.

#### 4. **Docker 리소스 제한 옵션**
- 리소스 제한 테스트를 위해 Docker Compose 파일을 수정합니다:

```yaml
services:
  app:
    ...
    deploy:
      resources:
        limits:
          memory: 1GB
          cpus: '1'
    ...
```

#### 5. **실행 결과**
- **시나리오 1: 동시 조회 요청 처리**
  - **부하 테스트**:
  ![grafana](https://i.ibb.co/0jhMwZM/1-1.png)

    - 총 요청 수: 18,394회 (305.48/s)
    - 평균 요청 시간: 326.61ms (최소 212.23ms, 최대 1.77초)
    - 성공률: 100% (요청 실패율 0%)
    - 데이터 전송: 송신 2.1MB, 수신 80MB
    - 동시 사용자(VU): 100명
    - 모든 요청이 성공적으로 처리되었으며, 평균 응답 시간과 처리량이 안정적이었습니다.
  
  - **내구성 테스트**:
    ![grafana](https://i.ibb.co/r35t1q9/1-2.png)
    - 총 요청 수: 50,259회 (278.98/s)
    - 평균 요청 시간: 179.02ms (최소 104.25ms, 최대 1.35초)
    - 성공률: 100% (요청 실패율 0%)
    - 데이터 전송: 송신 5.7MB, 수신 217MB
    - 동시 사용자(VU): 50명
    - 요청은 모두 성공적으로 처리되었으며, 안정적인 응답 시간이 기록되었습니다.
  
  - **스트레스 테스트**:
    ![grafana](https://i.ibb.co/Fw7ypgD/1-3.png)
    - 총 요청 수: 85,811회 (286.04/s)
    - 평균 요청 시간: 349.43ms (최소 2.18ms, 최대 1.96초)
    - 성공률: 100% (요청 실패율 0%)
    - 데이터 전송: 송신 9.8MB, 수신 371MB
    - 동시 사용자(VU): 200명
    - 모든 요청이 성공적으로 처리되었으며, 응답 시간이 안정적으로 유지되었습니다.
  
  - **최고 부하 테스트**:
    ![grafana](https://i.ibb.co/yW3TH7Z/1-4.png)
    - 총 요청 수: 7,838회 (261.27/s)
    - 평균 요청 시간: 2.05초 (최소 2.89ms, 최대 4.16초)
    - 성공률: 100% (요청 실패율 0%)
    - 데이터 전송: 송신 894KB, 수신 34MB
    - 동시 사용자(VU): 1,000명
    - 응답 시간이 길어져 평균 2초를 초과하는 요청 시간이 발생하였습니다.

- **시나리오 2: 동시 대기열 요청 처리**
  - **부하 테스트**:
    ![grafana](https://i.ibb.co/Ks52f3v/2-1.png)
    - 총 요청 수: 27,501회 (457.1/s)
    - 평균 요청 시간: 218.39ms (최소 144.9ms, 최대 1.31초)
    - 성공률: 100% (모든 요청 성공)
    - 데이터 전송: 송신 7.0MB, 수신 17MB
    - 동시 사용자(VU): 100명
    - 모든 요청이 성공적으로 처리되었으며, 평균 응답 시간이 218.39ms로 짧고 안정적이었습니다.

  - **내구성 테스트**:
    ![grafana](https://i.ibb.co/4S4fT5J/2-2.png)
    - 총 요청 수: 86,263회 (479.1/s)
    - 평균 요청 시간: 104.27ms (최소 46.87ms, 최대 1.36초)
    - 성공률: 100% (모든 요청 성공)
    - 데이터 전송: 송신 22MB, 수신 55MB
    - 동시 사용자(VU): 50명
    - 요청 처리량이 높은 환경에서도 성능 저하 없이 시스템이 잘 동작했습니다.
  
  - **스트레스 테스트**:
    ![grafana](https://i.ibb.co/Qj4sCrF/2-3.png)
    - 총 요청 수: 130,433회 (434.77/s)
    - 평균 요청 시간: 298.89ms (최소 2.43ms, 최대 2.39초)
    - 성공률: 100% (모든 요청 성공)
    - 데이터 전송: 송신 33MB, 수신 83MB
    - 동시 사용자(VU): 300명
    - 300명의 동시 사용자 환경에서도 시스템은 높은 처리량을 유지하며 안정적으로 요청을 처리했습니다.
  
  - **최고 부하 테스트**:
    - 총 요청 수: 12,494회 (416.4/s)
    - 평균 요청 시간: 1.25초 (최소 5.24ms, 최대 3.04초)
    - 성공률: 100% (모든 요청 성공)
    - 데이터 전송: 송신 3.2MB, 수신 7.9MB
    - 동시 사용자(VU): 1,000명
    - 1,000명의 동시 사용자가 시스템에 부하를 주었지만, 요청을 실패 없이 처리했으며, 응답 시간이 상대적으로 길어졌습니다. 최적화가 필요할 수 있습니다.

